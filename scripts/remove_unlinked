#!/usr/bin/env python3

import os
import sys
import argparse
from pathlib import Path

def is_orphan(file_path: Path) -> bool:
    """Return True if file has hard-link count == 1 (i.e. no other links)."""
    try:
        st = file_path.stat()
    except FileNotFoundError:
        return False
    # Only regular files
    if not file_path.is_file():
        return False
    return st.st_nlink == 1

def find_orphans(folder: Path):
    """Yield Path objects for orphan files under folder (not dirs)."""
    for root, dirs, files in os.walk(folder):
        for fname in files:
            p = Path(root) / fname
            if is_orphan(p):
                yield p

def safe_delete(path: Path, *, confirm: bool = False, dry_run: bool = True):
    """Delete the path if allowed. Returns True if deleted."""
    # Safety guard: ensure it's inside a base folder (no .. trickery)
    # (You can expand this check based on your constraints.)
    # e.g. refuse if path is root or parent of your library, etc.
    if dry_run:
        print("[DRY RUN] Would delete:", path)
        return False
    if confirm:
        resp = input(f"Delete {path}? [y/N] ")
        if resp.lower() != 'y':
            print("Skipping", path)
            return False
    try:
        path.unlink()
        print("Deleted:", path)
        return True
    except Exception as e:
        print("Error deleting", path, ":", e)
        return False

def main():
    parser = argparse.ArgumentParser(description="Delete unlinked (hard link count=1) files in downloads folder.")
    parser.add_argument("folder", help="Target folder to clean", type=Path)
    parser.add_argument("--doit", action="store_true", help="Actually delete (not just dry run)")
    parser.add_argument("--yes", action="store_true", help="Donâ€™t prompt for confirmation on each file")
    args = parser.parse_args()

    folder = args.folder.resolve()
    if not folder.is_dir():
        print("Error: folder is not a directory:", folder)
        sys.exit(1)

    print("Scanning folder:", folder)
    orphans = list(find_orphans(folder))
    print(f"Found {len(orphans)} orphan files (hard link count = 1).")

    for p in orphans:
        safe_delete(p, confirm=not args.yes, dry_run=not args.doit)

    print("Done.")

if __name__ == "__main__":
    main()
